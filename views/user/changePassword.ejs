<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Change Password</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body {
      margin: 0;
      font-family: Outfit;
      background: #dba39a;
    }

    .dashboard-container {
      display: flex;
      width: 98%;
      height: 85vh;
      margin: 20px auto;
      background: #fff;
      border-radius: 30px;
      overflow: hidden;
    }

    .sidebar-area {
      width: 260px;
      background: #fff5f2;
      padding: 2rem 1.5rem;
    }

    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      display: flex;
      justify-content: center;
    }

    .password-form-container {
      width: 100%;
      max-width: 500px;
    }

    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #5c2823;
    }

    .form-group {
      margin-bottom: 18px;
    }

    label {
      font-weight: 600;
      color: #8c5852;
      display: block;
      margin-bottom: 6px;
    }

    input {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: none;
      background: #fbdfdd;
    }

    button {
      width: 100%;
      padding: 14px;
      background: #bd7b72;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 15px;
    }

    .success {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 15px;
    }

    .google-card {
  text-align: center;
  padding: 30px;
  background: #fff5f2;
  border-radius: 16px;
  border: 1px dashed #bd7b72;
  margin-bottom: 20px;
  
}

.google-card i {
  font-size: 3rem;
  color: #db4437;
  margin-bottom: 15px;
}

.google-card h3 {
  color: #5c2823;
  margin-bottom: 12px;
}

.google-card p {
  color: #8c5852;
  line-height: 1.6;
  font-size: 0.95rem;
}

.google-card a {
  display: inline-block;
  margin-top: 18px;
  background: #db4437;
  color: white;
  padding: 12px 20px;
  border-radius: 10px;
  text-decoration: none;
  font-weight: 600;
}

  </style>
</head>

<body>

<!-- ✅ HEADER -->
<%- include("../../views/partials/user/h2") %>

<div class="dashboard-container">

  <!-- ✅ SIDEBAR -->
  <aside class="sidebar-area">
    <%- include("../../views/partials/user/sider") %>
  </aside>

  <!-- ✅ CONTENT -->
  <main class="main-content">
    <div class="password-form-container">

      <h2 style="margin-bottom: 80px; color: #AF5454;">Change Password</h2>

      <% if (error) { %>
        <div class="error"><%= error %></div>
      <% } %>

      <% if (success) { %>
        <div class="success"><%= success %></div>
      <% } %>

      <%
        const isGoogleUser = user && user.authType === "google";
        const hasPassword = user && user.password;
      %>

      <% if (isGoogleUser || (!isGoogleUser && !hasPassword)) { %>
  <div class="google-card">
    <i class="fab fa-google"></i>

    <h3>Google Account Login</h3>

    <p>
      This account was created using <strong>Google Sign-In</strong>.<br>
      Passwords for Google accounts cannot be changed here.<br>
      Please manage your password directly from your Google account.
    </p>

    <a href="https://myaccount.google.com/security" target="_blank">
      Manage Google Password
    </a>
  </div>
<% } %>


      <!-- ✅ SHOW FORM ONLY IF PASSWORD EXISTS -->
      <% if (!isGoogleUser && hasPassword) { %>
        <form action="/changePassword" method="POST" onsubmit="return validatePasswordForm()">

          <div class="form-group">
            <label>Current Password</label>
            <input
  type="password"
  name="currentPassword"
  id="currentPassword"
  required
  onblur="checkCurrentPassword()"
/>

<small
  id="currentPassError"
  style="color:#c62828; display:none;"
>
  Current password is incorrect
</small>

          </div>

          <div class="form-group">
            <label>New Password</label>
            <input type="password" name="newPassword" required>
          </div>

          <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" name="confirmPassword" required>
          </div>

          <button type="submit">Update Password</button>
        </form>
      <% } %>

    </div>
  </main>
</div>

<script>
  function validatePasswordForm() {
    const current = document.querySelector('[name="currentPassword"]').value.trim();
    const newPass = document.querySelector('[name="newPassword"]').value.trim();
    const confirm = document.querySelector('[name="confirmPassword"]').value.trim();

    if (!current || !newPass || !confirm) {
      alert("All fields are required");
      return false;
    }

    if (newPass.length < 8) {
      alert("Password must be at least 8 characters");
      return false;
    }

    if (newPass !== confirm) {
      alert("Passwords do not match");
      return false;
    }

    return true;
  }
</script>
<script>
async function checkCurrentPassword() {
  const currentPassword = document.getElementById("currentPassword").value.trim();
  const errorEl = document.getElementById("currentPassError");

  if (!currentPassword) {
    errorEl.style.display = "none";
    return;
  }

  const res = await fetch("/checkCurrentPassword", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ currentPassword })
  });

  const data = await res.json();

  errorEl.style.display = data.valid ? "none" : "block";
}
</script>


</body>
</html>
